version: "3.2"

services:

  functions-node-18:
    image: functions-node-18
    build:
      context: ..
      dockerfile: ./docker/functions-node-18/Dockerfile
    command: /bin/true

  cosmosdb:
    image: cosmosdb
    env_file:
      - ./environments/generated/env.cosmosdb
    build:
      context: ../docker/cosmosdb
      dockerfile: ./Dockerfile
    ports:
      - ${COSMOSDB_PORT}:3000

  storage-account:
    image: mcr.microsoft.com/azure-storage/azurite:3.9.0@sha256:6b6c9c24e97a6c000a81503a41bbf366f04c23aa3b473bfc27267145c92eeceb
    ports:
      - 10000:10000
      - 10001:10001
      - 10002:10002

  function:
    image: fn
    env_file:
      - ./environments/generated/env.function
    build:
      context: ..
      dockerfile: ./docker/functions/Dockerfile
    ports:
      - ${FUNCTION_PORT}:7071
    links:
      - cosmosdb
      - storage-account
    depends_on:
      - functions-node-18

  testagent:
    image: node:18-alpine@sha256:6eb9c3d9bd191bd2cc6ce7ec3d5ec4c2127616140c8586af96a6bec8f28689d1
    working_dir: /usr/src/app
    command: tail -f /dev/null # to keep it   up&running
    env_file:
      - environments/generated/env.integration-tests
    volumes:
      - "./:/usr/src/app"
      - "../openapi:/usr/src/openapi"
      - "../model:/usr/src/model"
      - "../generated:/usr/src/generated"
      - "../__mocks__:/usr/src/__mocks__"
      - "../node_modules:/usr/src/node_modules"
      - "../utils:/usr/src/utils"
    depends_on:
      - cosmosdb
      - storage-account
    links:
      - function
